version: '3.8'

volumes:
  postgres_data:

services:
  # PostgreSQL Database for Authentication & User Management
  postgres:
    image: postgres:15-alpine
    container_name: luxury-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: luxury_supply_chain
      POSTGRES_USER: dbadmin
      POSTGRES_PASSWORD: SecureDBPassword2024!
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/auth/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - luxury-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dbadmin -d luxury_supply_chain"]
      interval: 10s
      timeout: 5s
      retries: 5
  # LuxeBags Backend (Brand)
  luxebags-backend:
    build: ./backend
    container_name: luxebags-backend
    ports:
      - "4001:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - BRAND_ID=luxebags
      - ORG_ID=luxebags
      - USER_ID=Admin
      - JWT_SECRET=${JWT_SECRET:-change-this-secure-secret-min-32-chars}
      - CONSENSUS_API_PORT=4000
      - CUSTOMER_API_PORT=3002
      - DB_TYPE=postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=luxury_supply_chain
      - POSTGRES_USER=dbadmin
      - POSTGRES_PASSWORD=SecureDBPassword2024!
      - INIT_DEFAULT_USERS=true
      - FABRIC_CRYPTO_PATH=/app/fabric/organizations
      - CONFIG_PATH=/config/brands/example-brand
      - IDENTITY_PATH=/app/identities/luxebags
      - FABRIC_PEER_HOST=peer0.luxebags.luxe-bags.luxury
    volumes:
      - ./backend:/app
      - ./config:/config:ro
      - ./backend/gateway/network/organizations:/app/fabric/organizations:ro
    networks:
      - luxury-network
    depends_on:
      - fabric-network
      - postgres

  # Italian Leather Backend (Supplier)
  italianleather-backend:
    build: ./backend
    container_name: italianleather-backend
    ports:
      - "4002:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - BRAND_ID=italianleather
      - ORG_ID=italianleather
      - USER_ID=Admin
      - JWT_SECRET=italianleather-secret-change-in-production
      - CONSENSUS_API_PORT=4000
      - CUSTOMER_API_PORT=3002
      - FABRIC_CRYPTO_PATH=/app/fabric/organizations
      - CONFIG_PATH=/config/brands/example-brand
      - IDENTITY_PATH=/app/identities/italianleather
      - FABRIC_PEER_HOST=peer0.italianleather.luxe-bags.luxury
      - DB_TYPE=postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=luxury_supply_chain
      - POSTGRES_USER=dbadmin
      - POSTGRES_PASSWORD=SecureDBPassword2024!
    volumes:
      - ./backend:/app
      - ./config:/config:ro
      - ./backend/gateway/network/organizations:/app/fabric/organizations:ro
    networks:
      - luxury-network
    depends_on:
      - fabric-network
      - postgres

  # Craft Workshop Backend (Manufacturer)
  craftworkshop-backend:
    build: ./backend
    container_name: craftworkshop-backend
    ports:
      - "4003:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - BRAND_ID=craftworkshop
      - ORG_ID=craftworkshop
      - USER_ID=Admin
      - JWT_SECRET=craftworkshop-secret-change-in-production
      - CONSENSUS_API_PORT=4000
      - CUSTOMER_API_PORT=3002
      - FABRIC_CRYPTO_PATH=/app/fabric/organizations
      - CONFIG_PATH=/config/brands/example-brand
      - IDENTITY_PATH=/app/identities/craftworkshop
      - FABRIC_PEER_HOST=peer0.craftworkshop.luxe-bags.luxury
      - DB_TYPE=postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=luxury_supply_chain
      - POSTGRES_USER=dbadmin
      - POSTGRES_PASSWORD=SecureDBPassword2024!
    volumes:
      - ./backend:/app
      - ./config:/config:ro
      - ./backend/gateway/network/organizations:/app/fabric/organizations:ro
    networks:
      - luxury-network
    depends_on:
      - fabric-network
      - postgres

  # Luxury Retail Backend (Retailer)
  luxuryretail-backend:
    build: ./backend
    container_name: luxuryretail-backend
    ports:
      - "4004:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - BRAND_ID=luxuryretail
      - ORG_ID=luxuryretail
      - USER_ID=Admin
      - JWT_SECRET=luxuryretail-secret-change-in-production
      - CONSENSUS_API_PORT=4000
      - CUSTOMER_API_PORT=3002
      - FABRIC_CRYPTO_PATH=/app/fabric/organizations
      - CONFIG_PATH=/config/brands/example-brand
      - IDENTITY_PATH=/app/identities/luxuryretail
      - FABRIC_PEER_HOST=peer0.luxuryretail.luxe-bags.luxury
      - DB_TYPE=postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=luxury_supply_chain
      - POSTGRES_USER=dbadmin
      - POSTGRES_PASSWORD=SecureDBPassword2024!
    volumes:
      - ./backend:/app
      - ./config:/config:ro
      - ./backend/gateway/network/organizations:/app/fabric/organizations:ro
    networks:
      - luxury-network
    depends_on:
      - fabric-network
      - postgres

  # Customer Gateway (for C2C operations)
  customer-gateway:
    build: ./backend
    container_name: customer-gateway
    ports:
      - "3010:3010"
    environment:
      - NODE_ENV=production
      - CUSTOMER_GATEWAY_PORT=3010
      - RETAILER_BACKEND_URL=http://luxuryretail-backend:4000
      - SERVICE_ACCOUNT_USERNAME=store@luxuryretail.com
      - SERVICE_ACCOUNT_PASSWORD=LuxuryRetail2024!
    command: ["sh", "-c", "cd customer-gateway && npm install && npm run build && npm start"]
    volumes:
      - ./backend:/app
    working_dir: /app
    networks:
      - luxury-network
    depends_on:
      - luxuryretail-backend

  # B2B Frontend
  frontend:
    build: ./frontend/web-app
    container_name: luxury-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_LUXEBAGS_API=http://localhost:4001
      - NEXT_PUBLIC_ITALIANLEATHER_API=http://localhost:4002
      - NEXT_PUBLIC_CRAFTWORKSHOP_API=http://localhost:4003
      - NEXT_PUBLIC_LUXURYRETAIL_API=http://localhost:4004
      - NEXT_PUBLIC_CUSTOMER_GATEWAY_API=http://localhost:3010
    networks:
      - luxury-network
    depends_on:
      - luxebags-backend
      - italianleather-backend
      - craftworkshop-backend
      - luxuryretail-backend
      - customer-gateway

  # Customer Frontend
  customer-frontend:
    build: ./frontend/customer-app
    container_name: luxury-customer-frontend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_CUSTOMER_GATEWAY_URL=http://localhost:3010
      - NEXT_PUBLIC_RETAILER_API_URL=http://localhost:4004
    networks:
      - luxury-network
    depends_on:
      - customer-gateway
      - luxuryretail-backend

  # Placeholder for fabric network (already running)
  fabric-network:
    image: alpine:latest
    container_name: fabric-placeholder
    command: tail -f /dev/null
    networks:
      - luxury-network

networks:
  luxury-network:
    external: true
    name: luxury-supply-chain